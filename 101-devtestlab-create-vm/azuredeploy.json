{
  "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "vmName": {
      "type": "string",
      "metadata": {
        "description": "The name of the new vm to be created."
      }
    },
    "labName": {
      "type": "string",
      "metadata": {
        "description": "The name of an existing lab where the new vm will be created. The lab's resource group should be the same as the one to which this template is being deployed."
      }
    },
    "vmTemplateName": {
      "type": "string",
      "metadata": {
        "description": "The name of an existing vm template which will be used to creat the new vm. The specified vm template must exist in the lab (identified via the 'labName' parameter)."
      }
    },
    "vmSize": {
      "type": "string",
      "metadata": {
        "description": "The size of the new vm to be created."
      }
    },
    "useSshKey": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "If true, then a SSH key must be specified (the password will be ignored). If false, a password must be specified (the SSH key will be ignored)."
      }
    },
    "sshKey": {
      "type": "securestring",
      "defaultValue": "ignore",
      "metadata": {
        "description": "The SSH key. If using this, then the 'useSshKey' parameter must be set to true."
      }
    },
    "userName": {
      "type": "string",
      "metadata": {
        "description": "The username."
      }
    },
    "password": {
      "type": "securestring",
      "defaultValue": "ignore",
      "metadata": {
        "description": "The password. If using this, then the 'useSshKey' parameter must be set to false."
      }
    }
  },
  "resources": [
    {
      "apiVersion": "2015-05-21-preview",
      "type": "Microsoft.DevTestLab/environments",
      "name": "[parameters('vmName')]",
      "location": "[resourceGroup().location]",
      "properties": {
        "labId": "[resourceId('Microsoft.DevTestLab/labs', parameters('labName'))]",
        "vms": [
          {
            "name": "[parameters('vmName')]",
            "vmTemplateName": "[parameters('vmTemplateName')]",
            "size": "[parameters('vmSize')]",
            "isAuthenticationWithSshKey": "[parameters('useSshKey')]",
            "sshKey": "[parameters('useSshKey')]",
            "userName": "[parameters('userName')]",
            "password": "[parameters('password')]"
          }
        ]
      }
    }
  ],
  "outputs": {
    "vmId": {
      "type": "string",
      "value": "[resourceId('Microsoft.DevTestLab/environments', parameters('vmName'))]"
    }
  }
}
