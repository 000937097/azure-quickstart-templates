{
  "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
	"dnsZoneName": {
		"type" : "string",
		"defaultValue": "private.local",
		"metadata" : {
			"description": "The private DNS suffix and zone name."
		}
	},
   "newStorageAccountName": {
		"type": "string",
		"metadata": {
			"description": "The name of the new storage account created to store the VMs disks"
		}
    },
    "adminUsername": {
		"type": "string",
		"metadata": {
			"description": "The name of the Administrator of the new VM and Domain"
		},
		"defaultValue": "adAdministrator"
    },
    "adminPassword": {
		"type": "securestring",
		"metadata": {
			"description": "The password for the Administrator account of the new VM and Domain"
		}
    },	
	"serverPublicDnsName": {
		"type": "string",
		"metadata": {
			"description": "The DNS prefix for the public IP address used by the Load Balancer infront of the DNS servers"
		}
    },
    "assetLocation": {
      "type": "string",
      "metadata": {
        "description": "The location of resources, such as templates and scripts, that this script depends on"
      }
    }
  },
  "variables": {
	"adTemplate": "https://raw.githubusercontent.com/Azure/azure-quickstart-templates/master/active-directory-new-domain-ha-2-dc/azuredeploy.json",
	"vmTemplate": "[concat(parameters('assetLocation'), '/nested/genericvm.json')]",
	"serverTemplate": "[concat(parameters('assetLocation'),'/server/setupServer.json')]",
	"windowsClientTemplate": "[concat(parameters('assetLocation'),'/clients/windows/setupwinclient.json')]",
	"linuxClientTemplate": "[concat(parameters('assetLocation'),'/clients/linux/setuplinuxclient.json')]",
	"apiVersion": "2016-06-01",
	"virtualNetworkName": "adVNet",
	"subnetName": "default",
	"VnetID": "[resourceId('Microsoft.Network/virtualNetworks', variables('virtualNetworkName'))]",
    "subnetId": "[concat(variables('VnetID'),'/subnets/',variables('subnetName'))]",
	"storageId": "[resourceId(resourceGroup().name, 'Microsoft.Storage/storageAccounts', parameters('newStorageAccountName'))]",
	"adPDCVMName": "adPDC",
	"adBDCVMName": "adBDC"
  },
  "resources":
  [
	{
		"comments": "Create an example Windows client VM",
		"name": "setupWindowsClient",
		"type":"Microsoft.Resources/deployments",
		"apiVersion": "[variables('apiVersion')]",
		"properties": {
			"mode": "Incremental",
			"templateLink": {
				"uri": "[variables('vmTemplate')]",
				"contentVersion": "1.0.0.0"
			},
			"parameters": {
				"vmName": {
					"value": "WindowsClient"
				},
				"adminUsername":{
					"value": "[parameters('adminUsername')]"
				},
				"adminPassword":{
					"value": "parameters('adminPassword')"
				},
				"subnetId": {
					"value": "[variables('subnetId')]"
				},
				"imagePublisher": {
					"value": "MicrosoftWindowsServer"
				},
				"imageOffer": {
				    "value": "WindowsServer"
				},
				"imageSKU": {
				    "value": "2012-R2-Datacenter"
				},
				"storageId": {
					"value": "[variables('storageId')]"
				}
			}
		}
	},
	{
		"comments": "Install the extension on the Windows Client",
		"name": "WindowsExtension",
		"type":"Microsoft.Resources/deployments",
		"dependsOn": ["Microsoft.Resources/deployments/setupWindowsClient"],
		"apiVersion": "[variables('apiVersion')]",
		"properties": {
			"mode": "Incremental",
			"templateLink": {
				"uri": "[variables('windowsClientTemplate')]",
				"contentVersion": "1.0.0.0"
			},
			"parameters": {
				"vmList":{
					"value": "WindowsClient"
				},
				"dnsZone": {
					"value": "[parameters('dnsZoneName')]"
				},
				"assetLocation":{
					"value": "[concat(parameters('assetLocation'), '/clients/windows/')]"
				}
			}
		}
	},
	{
		"comments": "Create an example Ubuntu client VM",
		"name": "setupLinuxClient",
		"type":"Microsoft.Resources/deployments",
		"apiVersion": "[variables('apiVersion')]",
		"properties": {
			"mode": "Incremental",
			"templateLink": {
				"uri": "[variables('vmTemplate')]",
				"contentVersion": "1.0.0.0"
			},
			"parameters": {
				"vmName": {
					"value": "LinuxClient"
				},
				"adminUsername":{
					"value": "[parameters('adminUsername')]"
				},
				"adminPassword":{
					"value": "parameters('adminPassword')"
				},
				"subnetId": {
					"value": "[variables('subnetId')]"
				},
				"imagePublisher": {
					"value": "Canonical"
				},
				"imageOffer": {
				    "value": "UbuntuServer"
				},
				"imageSKU": {
				    "value": "14.04.3-LTS"
				},
				"storageId": {
					"value": "[variables('storageId')]"
				}
			}
		}
	},
	{
		"comments": "Install the extension on the Linux Client",
		"name": "LinuxExtension",
		"type":"Microsoft.Resources/deployments",
		"dependsOn": ["Microsoft.Resources/deployments/setupLinuxClient"],
		"apiVersion": "[variables('apiVersion')]",
		"properties": {
			"mode": "Incremental",
			"templateLink": {
				"uri": "[variables('linuxClientTemplate')]",
				"contentVersion": "1.0.0.0"
			},
			"parameters": {
				"vmList":{
					"value": "LinuxClient"
				},
				"dnsZone": {
					"value": "[parameters('dnsZoneName')]"
				},
				"assetLocation":{
					"value": "[concat(parameters('assetLocation'), '/clients/linux/')]"
				}
				
			}
		}
	}	
  ]
}