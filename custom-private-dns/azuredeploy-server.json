{
  "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
	"dnsZoneName": {
		"type" : "string",
		"defaultValue": "private.local",
		"metadata" : {
			"description": "The private DNS suffix and zone name."
		}
	},
   "newStorageAccountName": {
		"type": "string",
		"metadata": {
			"description": "The name of the new storage account created to store the VMs disks"
		}
    },
    "adminUsername": {
		"type": "string",
		"metadata": {
			"description": "The name of the Administrator of the new VM and Domain"
		},
		"defaultValue": "adAdministrator"
    },
    "adminPassword": {
		"type": "securestring",
		"metadata": {
			"description": "The password for the Administrator account of the new VM and Domain"
		}
    },	
	"serverPublicDnsName": {
		"type": "string",
		"metadata": {
			"description": "The DNS prefix for the public IP address used by the Load Balancer infront of the DNS servers"
		}
    },
    "assetLocation": {
      "type": "string",
      "metadata": {
        "description": "The location of resources, such as templates and scripts, that this script depends on"
      }
    }
  },
  "variables": {
	"adTemplate": "https://raw.githubusercontent.com/Azure/azure-quickstart-templates/master/active-directory-new-domain-ha-2-dc/azuredeploy.json",
	"setupServerTemplate": "[concat(parameters('assetLocation'),'/server/setupServer.json')]",
	"apiVersion": "2016-06-01",
	"virtualNetworkName": "adVNet",
	"subnetName": "default",
	"adPDCVMName": "adPDC",
	"adBDCVMName": "adBDC"
  },
  "resources":
  [
	{
		"comments": "This uses one of the other templates to deploy a pair of AD controllers",
		"name":"adDeployment",
		"type":"Microsoft.Resources/deployments",
		"apiVersion": "[variables('apiVersion')]",
		"properties": {
			"mode": "Incremental",
			"templateLink": {
				"uri": "[variables('adTemplate')]",
				"contentVersion": "1.0.0.0"
			},
			"parameters": {
				"newStorageAccountName": {
					"value": "[parameters('newStorageAccountName')]"
				},
				"storageAccountType": {
					"value": "Standard_LRS"
				},
				"virtualNetworkName": {
					"value": "[variables('virtualNetworkName')]"
				},
				"adSubnetName": {
					"value": "[variables('subnetName')]"
				},
				"adVMSize": {
					"value": "Standard_D1"
				},
				"domainName": {
					"value": "[parameters('dnsZoneName')]"
				},
				"adminUsername": {
					"value": "[parameters('adminUsername')]"
				},
				"adminPassword": {
					"value": "[parameters('adminPassword')]"
				},
				"dnsPrefix": {
					"value": "[parameters('serverPublicDnsName')]"
				},
				"adPDCVMName": {
					"value": "[variables('adPDCVMName')]"
				},
				"adBDCVMName": {
					"value": "[variables('adBDCVMName')]"
				}
			}
        }
	},
	{
		"comments": "This deployment modifies the DNS servers to allow dynamic and reverse DNS",
		"name": "setupServer",
		"type":"Microsoft.Resources/deployments",
		"dependsOn" : ["Microsoft.Resources/deployments/adDeployment"],
		"apiVersion": "[variables('apiVersion')]",
		"properties": {
			"mode": "Incremental",
			"templateLink": {
				"uri": "[variables('setupServerTemplate')]",
				"contentVersion": "1.0.0.0"
			},
			"parameters": {
				"vmList": {
					"value": "[concat(variables('adPDCVMName'), ',', variables('adBDCVMName'))]"
				},
				"dnsZone": {
					"value": "[parameters('dnsZoneName')]"
				},
				"vnetName": {
					"value": "[variables('virtualNetworkName')]"
				},
				"relativeDownloadFolder": {
					"value": "./server"
				},
				"assetLocation": {
					"value": "[concat(parameters('assetLocation'), '/server')]"
				}
			}
		}
	}
  ]
}