{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "location": {
            "type": "string",
            "defaultValue": "[resourceGroup().location]",
            "metadata": {
                "description": "The resources location."
            }
        },
        "disablePublicIp": {
            "defaultValue": true,
            "type": "Bool",
            "metadata": {
                "description": "Specifies whether to deploy Azure Databricks workspace with secure cluster connectivity (SCC) enabled or not (No Public IP)."
            }
        },
        "nsgName": {
            "defaultValue": "databricks-nsg",
            "type": "String",
            "metadata": {
                "description": "The name of the network security group to create."
            }
        },
        "pricingTier": {
            "defaultValue": "premium",
            "allowedValues": [
                "trial",
                "standard",
                "premium"
            ],
            "type": "String",
            "metadata": {
                "description": "The pricing tier of workspace."
            }
        },
        "privateSubnetCidr": {
            "defaultValue": "10.179.0.0/18",
            "type": "String",
            "metadata": {
                "description": "CIDR range for the private subnet."
            }
        },
        "privateSubnetName": {
            "defaultValue": "private-subnet",
            "type": "String",
            "metadata": {
                "description": "The name of the private subnet to create."
            }
        },
        "publicNetworkAccess": {
            "defaultValue": "Disabled",
            "allowedValues": [
                "Enabled",
                "Disabled"
            ],
            "type": "String",
            "metadata": {
                "description": "Indicates whether public network access is allowed to the workspace with private endpoint - possible values are Enabled or Disabled."
            }
        },
        "publicSubnetCidr": {
            "defaultValue": "10.179.64.0/18",
            "type": "String",
            "metadata": {
                "description": "CIDR range for the public subnet."
            }
        },
        "privateEndpointSubnetCidr": {
            "defaultValue": "10.179.128.0/24",
            "type": "String",
            "metadata": {
                "description": "CIDR range for the private endpoint subnet.."
            }
        },
        "publicSubnetName": {
            "defaultValue": "public-subnet",
            "type": "String",
            "metadata": {
                "description": "The name of the public subnet to create."
            }
        },
        "requiredNsgRules": {
            "defaultValue": "NoAzureDatabricksRules",
            "allowedValues": [
                "AllRules",
                "NoAzureDatabricksRules"
            ],
            "type": "String",
            "metadata": {
                "description": "Indicates whether to retain or remove the AzureDatabricks outbound NSG rule - possible values are AllRules or NoAzureDatabricksRules."
            }
        },
        "vnetCidr": {
            "defaultValue": "10.179.0.0/16",
            "type": "String",
            "metadata": {
                "description": "CIDR range for the vnet."
            }
        },
        "vnetName": {
            "defaultValue": "databricks-vnet",
            "type": "String",
            "metadata": {
                "description": "The name of the virtual network to create."
            }
        },
        "PrivateEndpointSubnetName": {
            "defaultValue": "default",
            "type": "String",
            "metadata": {
                "description": "The name of the subnet to create the private endpoint in."
            }
        },
        "workspaceName": {
            "type": "string",
            "metadata": {
                "description": "The name of the Azure Databricks workspace to create."
            }
        },
        "azureDatabricksAppObjectId": {
            "type": "string",
            "metadata": {
                "description": "The object id of AzureDatabricks application in your tenant. Application ID: 2ff814a6-3304-4ab8-85cb-cd0e6f879c1d"
            }
        },
        "requireInfrastructureEncryption": {
            "defaultValue": false,
            "type": "bool"
        },
        "msCmkKeyVaultResourceGroup": {
            "type": "string",
            "defaultValue": "",
            "metadata": {
                "description": "Resource Group of the Key Vault that contains the CMK for managed services encryption"
            }
        },
        "msCmkKeyVaultName": {
            "type": "string",
            "defaultValue": "",
            "metadata": {
                "description": "Name of the Key Vault that contains the CMK for managed services encryption "
            }
        },
        "msCmkName": {
            "type": "string",
            "defaultValue": "",
            "metadata": {
                "description": "Name of the Customer Managed Key used to encrypt managed services data"
            }
        },
        "msCmkVersion": {
            "type": "string",
            "defaultValue": "",
            "metadata": {
                "description": "Version of the Customer Managed Key used to encrypt managed services data"
            }
        },
        "dbfsCmkKeyVaultName": {
            "type": "string",
            "defaultValue": "",
            "metadata": {
                "description": "Name of the Key Vault that contains the CMK used for DBFS encryption"
            }
        },
        "dbfsCmkName": {
            "type": "string",
            "defaultValue": "",
            "metadata": {
                "description": "Name of the Customer Managed Key used to encrypt DBFS data"
            }
        },
        "dbfsCmkVersion": {
            "type": "string",
            "defaultValue": "",
            "metadata": {
                "description": "Version of the Customer Managed Key used to encrypt DBFS data"
            }
        },
        "diskCmkKeyVaultResourceGroup": {
            "type": "string",
            "defaultValue": "",
            "metadata": {
                "description": "Resource Group of the Key Vault that contains the CMK for managed disks encryption"
            }
        },
        "diskCmkKeyVaultName": {
            "type": "string",
            "defaultValue": "",
            "metadata": {
                "description": "Name of the Key Vault that contains the CMK used for managed disks encryption"
            }
        },
        "diskCmkName": {
            "type": "string",
            "defaultValue": "",
            "metadata": {
                "description": "Name of the Customer Managed Key used to encrypt managed disks data"
            }
        },
        "diskCmkVersion": {
            "type": "string",
            "defaultValue": "",
            "metadata": {
                "description": "Version of the Customer Managed Key used to encrypt managed disks data"
            }
        },
        "diskCmkEnableAutoRotation": {
            "type": "string",
            "defaultValue": "false",
            "allowedValues": [
                "true",
                "false"
            ]
        }
    },
    "variables": {
        "managedResourceGroupId": "[concat(subscription().id, '/resourceGroups/', variables('managedResourceGroupName'))]",
        "managedResourceGroupName": "[concat('databricks-rg-', parameters('workspaceName'), '-', uniqueString(parameters('workspaceName'), resourceGroup().id))]",
        "privateEndpointName": "[concat(parameters('workspaceName'), '-', 'pvtEndpoint')]",
        "privateDnsZoneName": "privatelink.azuredatabricks.net",
        "pvtEndpointDnsGroupName": "[concat(variables('privateEndpointName'),'/mydnsgroupname')]",
        "msCmkKeyVaultUrl": "[concat('https://', parameters('msCmkKeyVaultName'), environment().suffixes.keyvaultDns)]",
        "dbfsCmkKeyVaultUrl": "[concat('https://', parameters('dbfsCmkKeyVaultName'), environment().suffixes.keyvaultDns)]",
        "diskCmkKeyVaultUrl": "[concat('https://', parameters('diskCmkKeyVaultName'), environment().suffixes.keyvaultDns)]"
    },
    "resources": [
        {
      "type": "Microsoft.Network/networkSecurityGroups",
      "apiVersion": "2021-03-01",
      "name": "[parameters('nsgName')]",
      "location": "[parameters('location')]",
      "properties": {
        "securityRules": [
          {
            "name": "Microsoft.Databricks-workspaces_UseOnly_databricks-worker-to-worker-inbound",
            "properties": {
              "description": "Required for worker nodes communication within a cluster.",
              "protocol": "*",
              "sourcePortRange": "*",
              "destinationPortRange": "*",
              "sourceAddressPrefix": "VirtualNetwork",
              "destinationAddressPrefix": "VirtualNetwork",
              "access": "Allow",
              "priority": 100,
              "direction": "Inbound"
            }
          },
          {
            "name": "Microsoft.Databricks-workspaces_UseOnly_databricks-worker-to-databricks-webapp",
            "properties": {
              "description": "Required for workers communication with Databricks Webapp.",
              "protocol": "Tcp",
              "sourcePortRange": "*",
              "destinationPortRange": "443",
              "sourceAddressPrefix": "VirtualNetwork",
              "destinationAddressPrefix": "AzureDatabricks",
              "access": "Allow",
              "priority": 100,
              "direction": "Outbound"
            }
          },
          {
            "name": "Microsoft.Databricks-workspaces_UseOnly_databricks-worker-to-sql",
            "properties": {
              "description": "Required for workers communication with Azure SQL services.",
              "protocol": "Tcp",
              "sourcePortRange": "*",
              "destinationPortRange": "3306",
              "sourceAddressPrefix": "VirtualNetwork",
              "destinationAddressPrefix": "Sql",
              "access": "Allow",
              "priority": 101,
              "direction": "Outbound"
            }
          },
          {
            "name": "Microsoft.Databricks-workspaces_UseOnly_databricks-worker-to-storage",
            "properties": {
              "description": "Required for workers communication with Azure Storage services.",
              "protocol": "Tcp",
              "sourcePortRange": "*",
              "destinationPortRange": "443",
              "sourceAddressPrefix": "VirtualNetwork",
              "destinationAddressPrefix": "Storage",
              "access": "Allow",
              "priority": 102,
              "direction": "Outbound"
            }
          },
          {
            "name": "Microsoft.Databricks-workspaces_UseOnly_databricks-worker-to-worker-outbound",
            "properties": {
              "description": "Required for worker nodes communication within a cluster.",
              "protocol": "*",
              "sourcePortRange": "*",
              "destinationPortRange": "*",
              "sourceAddressPrefix": "VirtualNetwork",
              "destinationAddressPrefix": "VirtualNetwork",
              "access": "Allow",
              "priority": 103,
              "direction": "Outbound"
            }
          },
          {
            "name": "Microsoft.Databricks-workspaces_UseOnly_databricks-worker-to-eventhub",
            "properties": {
              "description": "Required for worker communication with Azure Eventhub services.",
              "protocol": "Tcp",
              "sourcePortRange": "*",
              "destinationPortRange": "9093",
              "sourceAddressPrefix": "VirtualNetwork",
              "destinationAddressPrefix": "EventHub",
              "access": "Allow",
              "priority": 104,
              "direction": "Outbound"
            }
          }
        ]
      }
    },
    {
      "type": "Microsoft.Network/virtualNetworks",
      "apiVersion": "2021-08-01",
      "name": "[parameters('vnetName')]",
      "location": "[parameters('location')]",
      "dependsOn": [
        "[resourceId('Microsoft.Network/networkSecurityGroups', parameters('nsgName'))]"
      ],
      "properties": {
        "addressSpace": {
          "addressPrefixes": [
            "[parameters('vnetCidr')]"
          ]
        },
        "subnets": [
          {
            "name": "[parameters('publicSubnetName')]",
            "properties": {
              "addressPrefix": "[parameters('publicSubnetCidr')]",
              "networkSecurityGroup": {
                "id": "[resourceId('Microsoft.Network/networkSecurityGroups', parameters('nsgName'))]"
              },
              "delegations": [
                {
                  "name": "databricks-del-public",
                  "properties": {
                    "serviceName": "Microsoft.Databricks/workspaces"
                  }
                }
              ]
            }
          },
          {
            "name": "[parameters('privateSubnetName')]",
            "properties": {
              "addressPrefix": "[parameters('privateSubnetCidr')]",
              "networkSecurityGroup": {
                "id": "[resourceId('Microsoft.Network/networkSecurityGroups', parameters('nsgName'))]"
              },
              "delegations": [
                {
                  "name": "databricks-del-private",
                  "properties": {
                    "serviceName": "Microsoft.Databricks/workspaces"
                  }
                }
              ]
            }
          },
          {
            "name": "[parameters('PrivateEndpointSubnetName')]",
            "properties": {
              "addressPrefix": "[parameters('privateEndpointSubnetCidr')]",
              "privateEndpointNetworkPolicies": "Disabled"
            }
          }
        ]
      }
    },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2020-10-01",
            "name": "DatabricksManagedServicesCMKAccessPolicy",
            "resourceGroup": "[parameters('msCmkKeyVaultResourceGroup')]",
            "properties": {
                "mode": "Incremental",
                "template": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "0.9.0.0",
                    "resources": [
                        {
                            "type": "Microsoft.KeyVault/vaults/accessPolicies",
                            "apiVersion": "2019-09-01",
                            "name": "[concat(parameters('msCmkKeyVaultName'), '/add')]",
                            "properties": {
                                "accessPolicies": [
                                    {
                                        "objectId": "[parameters('azureDatabricksAppObjectId')]",
                                        "tenantId": "[subscription().tenantId]",
                                        "permissions": {
                                            "keys": [
                                                "get",
                                                "wrapKey",
                                                "unwrapKey"
                                            ]
                                        }
                                    }
                                ]
                            }
                        }
                    ]
                }
            }
        },
        {
            "type": "Microsoft.Databricks/workspaces",
            "apiVersion": "2023-02-01",
            "location": "[resourceGroup().location]",
            "name": "[parameters('workspaceName')]",
            "dependsOn": [
                "[resourceId(parameters('msCmkKeyVaultResourceGroup'), 'Microsoft.Resources/deployments', 'DatabricksManagedServicesCMKAccessPolicy')]"
            ],
            "sku": {
                "name": "[parameters('pricingTier')]"
            },
            "properties": {
                "managedResourceGroupId": "[variables('managedResourceGroupId')]",
                "parameters": {
                    "enableNoPublicIp": {
                        "value": true
                    },
                    "prepareEncryption": {
                        "value": true
                    },
                    "requireInfrastructureEncryption": {
                        "value": "[parameters('requireInfrastructureEncryption')]"
                    }
                },
                "encryption": {
                    "entities": {
                        "managedDisk": {
                            "keySource": "Microsoft.Keyvault",
                            "keyVaultProperties": {
                                "keyVaultUri": "[variables('diskCmkKeyVaultUrl')]",
                                "keyName": "[parameters('diskCmkName')]",
                                "keyVersion": "[parameters('diskCmkVersion')]"
                            },
                            "rotationToLatestKeyVersionEnabled": "[parameters('diskCmkEnableAutoRotation')]"
                        },
                        "managedServices": {
                            "keySource": "Microsoft.Keyvault",
                            "keyVaultProperties": {
                                "keyVaultUri": "[variables('msCmkKeyVaultUrl')]",
                                "keyName": "[parameters('msCmkName')]",
                                "keyVersion": "[parameters('msCmkVersion')]"
                            }
                        }
                    }
                }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2020-10-01",
            "name": "DatabricksDbfsCMKAccessPolicy",
            "resourceGroup": "[parameters('msCmkKeyVaultResourceGroup')]",
            "dependsOn": [
                "[resourceId('Microsoft.Databricks/workspaces', parameters('workspaceName'))]"
            ],
            "properties": {
                "mode": "Incremental",
                "template": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "0.9.0.0",
                    "resources": [
                        {
                            "type": "Microsoft.KeyVault/vaults/accessPolicies",
                            "apiVersion": "2019-09-01",
                            "name": "[concat(parameters('dbfsCmkKeyVaultName'), '/add')]",
                            "properties": {
                                "accessPolicies": [
                                    {
                                        "objectId": "[reference(resourceId('Microsoft.Databricks/workspaces', parameters('workspaceName')), '2023-02-01').storageAccountIdentity.principalId]",
                                        "tenantId": "[reference(resourceId('Microsoft.Databricks/workspaces', parameters('workspaceName')), '2023-02-01').storageAccountIdentity.tenantId]",
                                        "permissions": {
                                            "keys": [
                                                "get",
                                                "wrapKey",
                                                "unwrapKey"
                                            ]
                                        }
                                    }
                                ]
                            }
                        }
                    ]
                }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2020-06-01",
            "name": "DatabricksManagedDiskCMKAccessPolicy",
            "resourceGroup": "[parameters('diskCmkKeyVaultResourceGroup')]",
            "dependsOn": [
                "[resourceId('Microsoft.Databricks/workspaces', parameters('workspaceName'))]",
                "[resourceId(parameters('msCmkKeyVaultResourceGroup'), 'Microsoft.Resources/deployments', 'DatabricksDbfsCMKAccessPolicy')]"
            ],
            "properties": {
                "mode": "Incremental",
                "template": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "0.9.0.0",
                    "resources": [
                        {
                            "type": "Microsoft.KeyVault/vaults/accessPolicies",
                            "apiVersion": "2019-09-01",
                            "name": "[concat(parameters('diskCmkKeyVaultName'), '/add')]",
                            "properties": {
                                "accessPolicies": [
                                    {
                                        "objectId": "[reference(resourceId('Microsoft.Databricks/workspaces', parameters('workspaceName')), '2023-02-01').managedDiskIdentity.principalId]",
                                        "tenantId": "[reference(resourceId('Microsoft.Databricks/workspaces', parameters('workspaceName')), '2023-02-01').managedDiskIdentity.tenantId]",
                                        "permissions": {
                                            "keys": [
                                                "get",
                                                "wrapKey",
                                                "unwrapKey"
                                            ]
                                        }
                                    }
                                ]
                            }
                        }
                    ]
                }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2022-05-01",
            "name": "DatabricksDbfsCMKEnable",
            "dependsOn": [
                "[resourceId('Microsoft.Databricks/workspaces', parameters('workspaceName'))]",
                "[resourceId(parameters('msCmkKeyVaultResourceGroup'), 'Microsoft.Resources/deployments', 'DatabricksDbfsCMKAccessPolicy')]"
            ],
            "properties": {
                "mode": "Incremental",
                "template": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "0.9.0.0",
                    "resources": [
                        {
                            "type": "Microsoft.Databricks/workspaces",
                            "apiVersion": "2023-02-01",
                            "name": "[parameters('workspaceName')]",
                            "location": "[resourceGroup().location]",
                            "sku": {
                                "name": "[parameters('pricingTier')]"
                            },
                            "properties": {
                                "managedResourceGroupId": "[subscriptionResourceId('Microsoft.Resources/resourceGroups', variables('managedResourceGroupName'))]",
                                "encryption": {
                                    "entities": {
                                        "managedDisk": {
                                            "keySource": "Microsoft.Keyvault",
                                            "keyVaultProperties": {
                                                "keyVaultUri": "[variables('diskCmkKeyVaultUrl')]",
                                                "keyName": "[parameters('diskCmkName')]",
                                                "keyVersion": "[parameters('diskCmkVersion')]"
                                            },
                                            "rotationToLatestKeyVersionEnabled": "[parameters('diskCmkEnableAutoRotation')]"
                                        },
                                        "managedServices": {
                                            "keySource": "Microsoft.Keyvault",
                                            "keyVaultProperties": {
                                                "keyVaultUri": "[variables('msCmkKeyVaultUrl')]",
                                                "keyName": "[parameters('msCmkName')]",
                                                "keyVersion": "[parameters('msCmkVersion')]"
                                            }
                                        }
                                    }
                                },
                                "parameters": {
                                    "prepareEncryption": {
                                        "value": true
                                    },
                                    "encryption": {
                                        "value": {
                                            "keySource": "Microsoft.Keyvault",
                                            "keyvaulturi": "[variables('dbfsCmkKeyVaultUrl')]",
                                            "KeyName": "[parameters('dbfsCmkName')]",
                                            "keyversion": "[parameters('dbfsCmkVersion')]"
                                        }
                                    },
                                    "enableNoPublicIp": {
                                        "value": true
                                    },
                                    "requireInfrastructureEncryption": {
                                        "value": "[parameters('requireInfrastructureEncryption')]"
                                    }
                                }
                            }
                        }
                    ]
                }
            }
        }
    ],
    "outputs": {
        "workspaceId": {
            "type": "string",
            "value": "[reference(parameters('workspaceName')).workspaceId]"
        },
        "workspaceURL": {
            "type": "string",
            "value": "[reference(parameters('workspaceName')).workspaceUrl]"
        },
        "workspaceResourceId": {
            "type": "string",
            "value": "[resourceID('Microsoft.Databricks/workspaces', parameters('workspaceName'))]"
        }
    }
}
