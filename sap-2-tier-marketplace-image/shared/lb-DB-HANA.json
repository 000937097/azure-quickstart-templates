{
    "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "resourcePrefix": {
            "type": "string",
            "metadata": {
                "description": ""
            }
        },
        "loadBalancerName": {
            "type": "string",
            "metadata": {
                "description": ""
            }
        },
        "dbInstanceNumber": {
            "type": "int",
            "defaultValue": 4,
            "metadata": {
                "description": ""
            }
        },
        "subnetId": {
            "type": "string",
            "metadata": {
                "description": "The id of the subnet you want to use."
            }
        }
    },
    "variables": {
        "apiVerion": "2015-06-15",
        "lbPrefix": "[concat('lb', parameters('resourcePrefix'))]",
        "lbrulePrefix": "[concat(variables('lbPrefix'), 'Rule')]",
        "backendPoolDB": "[concat(variables('lbPrefix'), 'BackendPoolDB')]",
        "loadBalancerFrontendDB": "[concat(variables('lbPrefix'), 'FrontendDB')]",
        "lbProbePortDB": "[concat(variables('lbPrefix'), 'ProbePortDB')]",
        "lbProbePortInternalDB": "[add(62500, parameters('dbInstanceNumber'))]",
        "idleTimeoutInMinutesDB": 30
    },
    "resources": [],
    "outputs": {
        "nicBackAddressPools": {
            "value": [
                {
                    "id": "[concat(resourceId('Microsoft.Network/loadBalancers', parameters('loadBalancerName')), '/backendAddressPools/', variables('backendPoolDB'))]"
                }
            ],
            "type": "array"
        },
        "frontendIPConfigurations": {
            "value": [
                {
                    "properties": {
                        "subnet": {
                            "id": "[parameters('subnetId')]"
                        },
                        "privateIPAllocationMethod": "Dynamic"
                    },
                    "name": "[variables('loadBalancerFrontendDB')]"
                }
            ],
            "type": "array"
        },
        "backendAddressPools": {
            "value": [
                {
                    "name": "[variables('backendPoolDB')]"
                }
            ],
            "type": "array"
        },
        "loadBalancingRules": {
            "value": [
                {
                    "properties": {
                        "frontendIPConfiguration": {
                            "id": "[concat(resourceId('Microsoft.Network/loadBalancers', parameters('loadBalancerName')), '/frontendIpConfigurations/', variables('loadBalancerFrontendDB'))]"
                        },
                        "backendAddressPool": {
                            "id": "[concat(resourceId('Microsoft.Network/loadBalancers', parameters('loadBalancerName')), '/backendAddressPools/', variables('backendPoolDB'))]"
                        },
                        "probe": {
                            "id": "[concat(resourceId('Microsoft.Network/loadBalancers', parameters('loadBalancerName')), '/probes/', variables('lbProbePortDB'))]"
                        },
                        "protocol": "Tcp",
                        "frontendPort": "[add(30015, mul(parameters('dbInstanceNumber'), 100))]",
                        "backendPort": "[add(30015, mul(parameters('dbInstanceNumber'), 100))]",
                        "enableFloatingIP": true,
                        "idleTimeoutInMinutes": "[variables('idleTimeoutInMinutesDB')]"
                    },
                    "name": "[concat(variables('lbrulePrefix'), '3', padLeft(parameters('dbInstanceNumber'), 2, '0'), '15')]"
                },
                {
                    "properties": {
                        "frontendIPConfiguration": {
                            "id": "[concat(resourceId('Microsoft.Network/loadBalancers', parameters('loadBalancerName')), '/frontendIpConfigurations/', variables('loadBalancerFrontendDB'))]"
                        },
                        "backendAddressPool": {
                            "id": "[concat(resourceId('Microsoft.Network/loadBalancers', parameters('loadBalancerName')), '/backendAddressPools/', variables('backendPoolDB'))]"
                        },
                        "probe": {
                            "id": "[concat(resourceId('Microsoft.Network/loadBalancers', parameters('loadBalancerName')), '/probes/', variables('lbProbePortDB'))]"
                        },
                        "protocol": "Tcp",
                        "frontendPort": "[add(30017, mul(parameters('dbInstanceNumber'), 100))]",
                        "backendPort": "[add(30017, mul(parameters('dbInstanceNumber'), 100))]",
                        "enableFloatingIP": true,
                        "idleTimeoutInMinutes": "[variables('idleTimeoutInMinutesDB')]"
                    },
                    "name": "[concat(variables('lbrulePrefix'), '3', padLeft(parameters('dbInstanceNumber'), 2, '0'), '17')]"
                }
            ],
            "type": "array"
        },
        "probes": {
            "value": [
                {
                    "properties": {
                        "protocol": "Tcp",
                        "port": "[variables('lbProbePortInternalDB')]",
                        "intervalInSeconds": 5,
                        "numberOfProbes": 2
                    },
                    "name": "[variables('lbProbePortDB')]"
                }
            ],
            "type": "array"
        }
    }
}