{
    "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "loadBalancerName": {
            "type": "string",
            "metadata": {
                "description": ""
            }
        },
        "dbInstanceNumber": {
            "type": "int",
            "defaultValue": 4,
            "metadata": {
                "description": ""
            }
        },
        "subnetId": {
            "type": "string",
            "metadata": {
                "description": "The id of the subnet you want to use."
            }
        },
        "nicBackAddressPoolsArray": {
            "type": "array",
            "defaultValue": [],
            "metadata": {
                "description": ""
            }
        },
        "frontendIPConfigurationsArray": {
            "type": "array",
            "defaultValue": [],
            "metadata": {
                "description": ""
            }
        },
        "backendAddressPoolsArray": {
            "type": "array",
            "defaultValue": [],
            "metadata": {
                "description": ""
            }
        },
        "loadBalancingRulesArray": {
            "type": "array",
            "defaultValue": [],
            "metadata": {
                "description": ""
            }
        },
        "probesArray": {
            "type": "array",
            "defaultValue": [],
            "metadata": {
                "description": ""
            }
        }
    },
    "variables": {
        "apiVerion": "2015-06-15",
        "lbPrefix": "[concat('lb', padLeft(parameters('dbInstanceNumber'), 2, '0'))]",
        "lbrulePrefix": "[concat(variables('lbPrefix'), 'Rule')]",
        "backendPoolDB": "[concat(variables('lbPrefix'), 'BackendPoolDB')]",
        "loadBalancerFrontendDB": "[concat(variables('lbPrefix'), 'FrontendDB')]",
        "lbProbePortDB": "[concat(variables('lbPrefix'), 'ProbePortDB')]",
        "lbProbePortInternalDB": "[add(62500, parameters('dbInstanceNumber'))]",
        "idleTimeoutInMinutesDB": 30,
        "nicBackAddressPoolsResult": [
            {
                "id": "[concat(resourceId('Microsoft.Network/loadBalancers', parameters('loadBalancerName')), '/backendAddressPools/', variables('backendPoolDB'))]"
            }
        ],
        "frontendIPConfigurationsResult": [
            {
                "properties": {
                    "subnet": {
                        "id": "[parameters('subnetId')]"
                    },
                    "privateIPAllocationMethod": "Dynamic"
                },
                "name": "[variables('loadBalancerFrontendDB')]"
            }
        ],
        "backendAddressPoolsResult": [
            {
                "name": "[variables('backendPoolDB')]"
            }
        ],
        "loadBalancingRulesResult": [
            {
                "properties": {
                    "frontendIPConfiguration": {
                        "id": "[concat(resourceId('Microsoft.Network/loadBalancers', parameters('loadBalancerName')), '/frontendIpConfigurations/', variables('loadBalancerFrontendDB'))]"
                    },
                    "backendAddressPool": {
                        "id": "[concat(resourceId('Microsoft.Network/loadBalancers', parameters('loadBalancerName')), '/backendAddressPools/', variables('backendPoolDB'))]"
                    },
                    "probe": {
                        "id": "[concat(resourceId('Microsoft.Network/loadBalancers', parameters('loadBalancerName')), '/probes/', variables('lbProbePortDB'))]"
                    },
                    "protocol": "Tcp",
                    "frontendPort": 1433,
                    "backendPort": 1433,
                    "enableFloatingIP": true,
                    "idleTimeoutInMinutes": "[variables('idleTimeoutInMinutesDB')]"
                },
                "name": "[concat(variables('lbrulePrefix'), '1433')]"
            }
        ],
        "probesResult": [
            {
                "properties": {
                    "protocol": "Tcp",
                    "port": "[variables('lbProbePortInternalDB')]",
                    "intervalInSeconds": 5,
                    "numberOfProbes": 2
                },
                "name": "[variables('lbProbePortDB')]"
            }
        ]
    },
    "resources": [],
    "outputs": {
        "nicBackAddressPools": {
            "value": "[concat(parameters('nicBackAddressPoolsArray'), variables('nicBackAddressPoolsResult'))]",
            "type": "array"
        },
        "frontendIPConfigurations": {
            "value": "[concat(parameters('frontendIPConfigurationsArray'), variables('frontendIPConfigurationsResult'))]",
            "type": "array"
        },
        "backendAddressPools": {
            "value": "[concat(parameters('backendAddressPoolsArray'), variables('backendAddressPoolsResult'))]",
            "type": "array"
        },
        "loadBalancingRules": {
            "value": "[concat(parameters('loadBalancingRulesArray'), variables('loadBalancingRulesResult'))]",
            "type": "array"
        },
        "probes": {
            "value": "[concat(parameters('probesArray'), variables('probesResult'))]",
            "type": "array"
        }
    }
}