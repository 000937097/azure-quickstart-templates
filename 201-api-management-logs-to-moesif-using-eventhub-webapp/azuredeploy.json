{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "moesifApplicationId": {
            "type": "string",
            "minLength": 50,
            "metadata": {
                "description": "Your Moesif Application Id (aka Collector Application Id) can be found in the Moesif Portal. After signing up for a Moesif account, your Moesif Application Id will be displayed during the onboarding steps. Sets environment variable APIMEVENTS-MOESIF-APPLICATION-ID in App Service"
            }
        },
        "existingApiMgmtResourceGroup": {
            "type": "string",
            "defaultValue": "[resourceGroup().name]",
            "minLength": 0,
            "metadata": {
                "description": "Name of Resource Group of existing Api Management service. If blank, the current resource group is used"
            }
        },
        "existingApiMgmtName": {
            "type": "string",
            "defaultValue": "",
            "minLength": 0,
            "metadata": {
                "description": "Name of existing Api Management service. If blank, Log-to-eventhub logger is not created."
            }
        },
        "azureAppServiceSku": {
            "type": "string",
            "defaultValue": "B1",
            "allowedValues": [
                "B1", "B2", "B3", "S1", "S2", "S3", "P1v2", "P2v2", "P3v2", "P1v3", "P2v3", "P3v3"
            ],
            "metadata": {
                "description": "The instance / SKU name for Azure App Service eg: B1, B2, S1, P1V2. Note F1 and D1 shared plan are not supported as they do not support 'alwaysOn'"
            }
        },
        "dnsNamePrefix": {
            "type": "string",
            "defaultValue": "[concat('moesiflog', uniqueString(resourceGroup().id))]",
            "minLength": 6,
            "metadata": {
                "description": "A prefix that will be added to created resource names and DNS URLs. Allowed characters: alphabets and numbers only. Resulting name must be maximum 24 characters (storage account maximum)"
            }
        },
        "azureWebsitesDomain": {
            "type": "string",
            "metadata": {
                "description": "DNS name to use for azure webapp such as .azurewebsites.net"
            }
        },
        "location": {
            "type": "string",
            "defaultValue": "[resourceGroup().location]",
            "metadata": {
                "description": "Location for all resources. eg 'westus2'"
            }
        },
        "_artifactsLocation": {
            "type": "string",
            //"defaultValue": "https://raw.githubusercontent.com/Azure/azure-quickstart-templates/master/201-api-management-logs-to-moesif-using-eventhub-webapp/",
            "defaultValue": "https://raw.githubusercontent.com/Moesif/azure-quickstart-templates/moesif-apim-review-2021-01-03/201-api-management-logs-to-moesif-using-eventhub-webapp/",
            "metadata": {
                "description": "The base URL where templates are located. Should end with trailing '/'"
            }
        },
        "_artifactsLocationSasToken": {
            "type": "securestring",
            "defaultValue": "",
            "metadata": {
                "description": "The sasToken required to access _artifactsLocation.  When the template is deployed using the accompanying scripts, a sasToken will be automatically generated."
            }
        }
    },
    "functions": [],
    "variables": {
        "moesifSessionToken": "optional",
        "moesifApiVersion": "v1",
        "apiManagementLoggerId": "moesif-log-to-event-hub",
        "eventHubSendPolicyName": "[concat(parameters('dnsNamePrefix'), '-send-policy')]",
        "eventHubListenPolicy": "[concat(parameters('dnsNamePrefix'), '-listen-policy')]",
        "azStorageTemplUri": "[uri(parameters('_artifactsLocation'), concat('nested/microsoft.storage/storageaccounts.json', parameters('_artifactsLocationSasToken')))]",
        "azEventHubTemplUri": "[uri(parameters('_artifactsLocation'), concat('nested/microsoft.eventhub/namespaces.json', parameters('_artifactsLocationSasToken')))]",
        "loggersJsonRelPath": "nested/microsoft.apimanagement/service/loggers.json",
        "azAppServicePlanTemplUri": "[uri(parameters('_artifactsLocation'), concat('nested/microsoft.web/serverfarms.json', parameters('_artifactsLocationSasToken')))]",
        "azAppServiceTemplUri": "[uri(parameters('_artifactsLocation'), concat('nested/microsoft.web/sites.json', parameters('_artifactsLocationSasToken')))]",
        //"azAppServiceWebJobTemplUri": "[uri(parameters('_artifactsLocation'), concat('nested/microsoft.web/sites/extensions.json', parameters('_artifactsLocationSasToken')))]",
        //"azAppServiceWebJobZipUri": "[uri(parameters('_artifactsLocation'), concat('scripts/apim-2-moesif-webjob-webdeploy.zip', parameters('_artifactsLocationSasToken')))]",
        "storageAccountName": "[replace(parameters('dnsNamePrefix'), '-', '')]",
        "apiMgrSpecified": "[greater(length(parameters('existingApiMgmtName')), 0)]",
        "tags": { "purpose": "moesif" }
    },
    "resources": [
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2019-10-01",
            "name": "storage-deploy",
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[variables('azStorageTemplUri')]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "storageAccountName": {
                        "value": "[variables('storageAccountName')]"
                    },
                    "tags": {
                        "value": "[variables('tags')]"
                    },
                    "location": {
                        "value": "[parameters('location')]"
                    }
                }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2019-10-01",
            "name": "eventhub-deploy",
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[variables('azEventHubTemplUri')]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "eventHubNsName": {
                        "value": "[parameters('dnsNamePrefix')]"
                    },
                    "eventHubName": {
                        "value": "[parameters('dnsNamePrefix')]"
                    },
                    "eventHubSendPolicyName": {
                        "value": "[variables('eventHubSendPolicyName')]"
                    },
                    "eventHubListenPolicy": {
                        "value": "[variables('eventHubListenPolicy')]"
                    },
                    "tags": {
                        "value": "[variables('tags')]"
                    },
                    "location": {
                        "value": "[parameters('location')]"
                    }
                }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2019-10-01",
            "name": "api-management-logger-res-grp-deploy",
            "condition": "[variables('apiMgrSpecified')]",
            "resourceGroup": "[parameters('existingApiMgmtResourceGroup')]",
            "dependsOn": [
                "[resourceId('Microsoft.Resources/deployments', 'eventhub-deploy')]"
            ],
            "properties": {
                "mode": "Incremental",
                "expressionEvaluationOptions": {
                    "scope": "inner"
                },
                "parameters": {
                    "existingApiMgmtName": {
                        "value": "[parameters('existingApiMgmtName')]"
                    },
                    "logToEventhubLoggerId": {
                        "value": "[variables('apiManagementLoggerId')]"
                    },
                    "eventHubNS": {
                        "value": "[parameters('dnsNamePrefix')]"
                    },
                    "eventHubName": {
                        "value": "[parameters('dnsNamePrefix')]"
                    },
                    "eventHubPolicyName": {
                        "value": "[variables('eventHubSendPolicyName')]"
                    },
                    "tags": {
                        "value": "[variables('tags')]"
                    },
                    "loggersJsonRelPath": {
                        "value": "[variables('loggersJsonRelPath')]"
                    },
                    "_artifactsLocation": {
                        "value": "[parameters('_artifactsLocation')]"
                    },
                    "_artifactsLocationSasToken": {
                        "value": "[parameters('_artifactsLocationSasToken')]"
                    }
                },
                "template": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "1.0.0.0",
                    "parameters": {
                        "existingApiMgmtName": {
                            "type": "string"
                        },
                        "logToEventhubLoggerId": {
                            "type": "string"
                        },
                        "eventHubNS": {
                            "type": "string"
                        },
                        "eventHubName": {
                            "type": "string"
                        },
                        "eventHubPolicyName": {
                            "type": "string"
                        },
                        "tags": {
                            "type": "object"
                        },
                        "loggersJsonRelPath": {
                            "type": "string",
                            "metadata": {
                                "description": "description"
                            }
                        },
                        "_artifactsLocation": {
                            "type": "string",
                            "metadata": {
                                "description": "The base URL where templates are located. Should end with trailing '/'"
                            }
                        },
                        "_artifactsLocationSasToken": {
                            "type": "securestring",
                            "defaultValue": "",
                            "metadata": {
                                "description": "The sasToken required to access _artifactsLocation.  When the template is deployed using the accompanying scripts, a sasToken will be automatically generated."
                            }
                        }
                    },
                    "variables": {
                        "azApiMgmtLoggerInstallTemplUri": "[uri(parameters('_artifactsLocation'), concat(parameters('loggersJsonRelPath'), parameters('_artifactsLocationSasToken')))]"
                    },
                    "resources": [
                        {
                            "type": "Microsoft.Resources/deployments",
                            "apiVersion": "2019-10-01",
                            "name": "api-management-logger-deploy",
                            "properties": {
                                "mode": "Incremental",
                                "templateLink": {
                                    "uri": "[variables('azApiMgmtLoggerInstallTemplUri')]",
                                    "contentVersion": "1.0.0.0"
                                },
                                "parameters": {
                                    "existingApiMgmtName": {
                                        "value": "[parameters('existingApiMgmtName')]"
                                    },
                                    "logToEventhubLoggerId": {
                                        "value": "[parameters('logToEventhubLoggerId')]"
                                    },
                                    "eventHubLoggerConnStr": {
                                        "value": "[listKeys(resourceId('Microsoft.EventHub/namespaces/eventhubs/authorizationRules', parameters('eventHubNS'), parameters('eventHubName'), parameters('eventHubPolicyName')), '2017-04-01').primaryConnectionString]"
                                    },
                                    "tags": {
                                        "value": "[parameters('tags')]"
                                    }
                                }
                            }
                        }
                    ]

                }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2019-10-01",
            "name": "app-service-plan-deploy",
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[variables('azAppServicePlanTemplUri')]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "appServicePlanName": {
                        "value": "[parameters('dnsNamePrefix')]"
                    },
                    "appServiceSkuName": {
                        "value": "[parameters('azureAppServiceSku')]"
                    },
                    "tags": {
                        "value": "[variables('tags')]"
                    },
                    "location": {
                        "value": "[parameters('location')]"
                    }
                }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2019-10-01",
            "name": "app-service-deploy",
            "dependsOn": [
                "[resourceId('Microsoft.Resources/deployments', 'app-service-plan-deploy')]",
                "[resourceId('Microsoft.Resources/deployments', 'storage-deploy')]",
                "[resourceId('Microsoft.Resources/deployments', 'eventhub-deploy')]"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[variables('azAppServiceTemplUri')]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "appServiceName": {
                        "value": "[parameters('dnsNamePrefix')]"
                    },
                    "appServicePlanName": {
                        "value": "[parameters('dnsNamePrefix')]"
                    },
                    "eventHubNamespace": {
                        "value": "[parameters('dnsNamePrefix')]"
                    },
                    "eventHubName": {
                        "value": "[parameters('dnsNamePrefix')]"
                    },
                    "eventHubListenPolicy": {
                        "value": "[variables('eventHubListenPolicy')]"
                    },
                    "apimEvtStorName": {
                        "value": "[variables('storageAccountName')]"
                    },
                    "apimEvtMoesifApplicationId": {
                        "value": "[parameters('moesifApplicationId')]"
                    },
                    "apimEvtMoesifSessionToken": {
                        "value": "[variables('moesifSessionToken')]"
                    },
                    "apimEvtMoesifApiVersion": {
                        "value": "[variables('moesifApiVersion')]"
                    },
                    "azureWebsitesDomain": {
                        "value": "[parameters('azureWebsitesDomain')]"
                    },
                    "tags": {
                        "value": "[variables('tags')]"
                    },
                    "location": {
                        "value": "[parameters('location')]"
                    }
                }
            }
        }/*,
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2019-10-01",
            "name": "app-service-webjob-msdeploy",
            "dependsOn": [
                "[resourceId('Microsoft.Resources/deployments', 'app-service-deploy')]"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[variables('azAppServiceWebJobTemplUri')]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "appServiceName": {
                        "value": "[reference('app-service-deploy').outputs.appServiceName.value]"
                    },
                    "webJobZipDeployUrl": {
                        "value": "[variables('azAppServiceWebJobZipUri')]"
                    },
                    "location": {
                        "type": "string",
                        "metadata": {
                            "description": "Location for all resources. eg 'westus2'"
                        }
                    }
                }
            }
        }*/
    ],
    "outputs": {
        "logToEventhubLoggerId": {
            "type": "string",
            "condition": "[variables('apiMgrSpecified')]",
            "value": "[variables('apiManagementLoggerId')]"
        }
    }
}
