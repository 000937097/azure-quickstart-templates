{
  "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "sqlServerName": {
      "type": "string",
      "defaultValue": "[concat('server-', uniqueString(resourceGroup().id, deployment().name))]",
      "metadata": {
        "description": "Name of the SQL server"
      }
    },
    "location": {
      "type": "string",
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "Location for all resources."
      }
    },
    "sqlAdministratorLogin": {
      "type": "string",
      "metadata": {
        "description": "The administrator username of the SQL Server."
      }
    },
    "sqlAdministratorLoginPassword": {
      "type": "securestring",
      "metadata": {
        "description": "The administrator password of the SQL Server."
      }
    },
    "existingWorkspaceName": {
      "type": "string",
      "metadata": {
        "description": "Log Analytics workspace name/"
      }
    },
    "omsWorkspaceResourceGroup": {
      "type": "string",
      "defaultValue": "[resourceGroup().name]",
      "metadata": {
        "description": "The resource group of your OMS Log Analytics workspace."
      }
    }
  },
  "variables": {
  "diagnosticSettingsName": "SQLSecurityAuditEvents_3d229c42-c7e7-4c97-9a99-ec0d0d8b86c1",
  },
  "resources": [{
    "type": "Microsoft.Sql/servers",
    "apiVersion": "2015-05-01-preview",
    "location": "[parameters('location')]",
    "name": "[parameters('sqlServerName')]",
    "properties": {
      "administratorLogin": "[parameters('sqlAdministratorLogin')]",
      "administratorLoginPassword": "[parameters('sqlAdministratorLoginPassword')]",
      "version": "12.0"
    },
    "tags": {
      "DisplayName": "[parameters('sqlServerName')]"
    },
      "resources": [{
        "type": "databases/providers/diagnosticSettings",
        "name": "[concat('master/microsoft.insights/',variables('diagnosticSettingsName'))]",
        "dependsOn": [ "[parameters('sqlServerName')]", "[concat('Microsoft.Sql/servers/', parameters('sqlServerName'), '/auditingSettings/DefaultAuditingSettings')]" ],
        "apiVersion": "2017-05-01-preview",
        "properties": {
          "name": "[variables('diagnosticSettingsName')]",
          "workspaceId": "[resourceId(parameters('omsWorkspaceResourceGroup'), 'Microsoft.OperationalInsights/workspaces', parameters('existingWorkspaceName'))]",
          "logs": [{
              "category": "SQLSecurityAuditEvents",
              "enabled": true,
              "retentionPolicy": {
                "days": 0,
                "enabled": false
              }
          }]
        }
      },
      {
        "apiVersion": "2017-03-01-preview",
        "type": "auditingSettings",
        "name": "DefaultAuditingSettings",
        "dependsOn": [ "[parameters('sqlServerName')]" ],
        "properties": {
          "State": "Enabled",
          "auditActionsAndGroups": null,
          "isAzureMonitorTargetEnabled": true
        }
      }]
   }]
}