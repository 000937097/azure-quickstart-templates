{
    "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "IncomingDeliveryRequestsTopicName": {
            "defaultValue": "incomingdeliveryrequests",
            "metadata": {
                "description": "The name for the Service Bus Topic."
            },
            "type": "string"
        },
        "MessageRouterServiceBusNamespacePrefix": {
            "defaultValue": "MessageRouterServiceBus",
            "metadata": {
                "description": "The prefix of the name for the Service Bus namespace, will be appended with a unique string."
            },
            "type": "string"
        }
    },
    "variables": {
        "serviceBusNamespaceName": "[concat(parameters('MessageRouterServiceBusNamespacePrefix'), '-', uniquestring(resourceGroup().id))]"
    },
    "resources": [
        {
            "apiVersion": "2015-08-01",
            "dependsOn": [],
            "kind": "Messaging",
            "location": "[resourceGroup().location]",
            "name": "[variables('serviceBusNamespaceName')]",
            "sku": {
                "capacity": 1,
                "name": "Standard",
                "tier": "Standard"
            },
            "type": "Microsoft.ServiceBus/namespaces"
        },
        {
            "apiVersion": "2015-08-01",
            "dependsOn": [
                "[resourceId('Microsoft.ServiceBus/namespaces', variables('serviceBusNamespaceName'))]"
            ],
            "location": "[resourceGroup().location]",
            "name": "[concat(variables('serviceBusNamespaceName'), '/', parameters('IncomingDeliveryRequestsTopicName'))]",
            "properties": {
                "defaultMessageTimeToLive": "14.00:00:00",
                "enableBatchedOperations": false,
                "enableExpress": false,
                "enablePartitioning": true,
                "enableSubscriptionPartitioning": false,
                "filteringMessagesBeforePublishing": false,
                "isAnonymousAccessible": false,
                "isExpress": false,
                "maxSizeInMegabytes": 1024,
                "requiresDuplicateDetection": false,
                "sizeInBytes": 0,
                "supportOrdering": false
            },
            "type": "Microsoft.ServiceBus/namespaces/topics"
        },
        {
            "apiVersion": "2015-08-01",
            "dependsOn": [
                "[resourceId('Microsoft.ServiceBus/namespaces', variables('serviceBusNamespaceName'))]",
                "[resourceId('Microsoft.ServiceBus/namespaces/topics', variables('serviceBusNamespaceName'), parameters('IncomingDeliveryRequestsTopicName'))]"
            ],
            "location": "[resourceGroup().location]",
            "name": "[concat(variables('serviceBusNamespaceName'), '/', parameters('IncomingDeliveryRequestsTopicName'), '/HighPriority')]",
            "properties": {
                "deadLetteringOnFilterEvaluationExceptions": false,
                "deadLetteringOnMessageExpiration": true,
                "defaultMessageTimeToLive": "14.00:00:00",
                "enableBatchedOperations": false,
                "lockDuration": "00:00:30",
                "maxDeliveryCount": 10,
                "requiresSession": false
            },
            "resources": [
                {
                    "apiVersion": "2015-08-01",
                    "dependsOn": [
                        "[resourceId('Microsoft.ServiceBus/namespaces/topics/subscriptions', variables('serviceBusNamespaceName'), parameters('IncomingDeliveryRequestsTopicName'), 'HighPriority')]"
                    ],
                    "name": "HighPriority",
                    "properties": {
                        "filter": {
                            "sqlExpression": "Priority='High'"
                        }
                    },
                    "type": "Rules"
                }
            ],
            "type": "Microsoft.ServiceBus/namespaces/topics/subscriptions"
        },
        {
            "apiVersion": "2015-08-01",
            "dependsOn": [
                "[resourceId('Microsoft.ServiceBus/namespaces', variables('serviceBusNamespaceName'))]",
                "[resourceId('Microsoft.ServiceBus/namespaces/topics', variables('serviceBusNamespaceName'), parameters('IncomingDeliveryRequestsTopicName'))]"
            ],
            "location": "[resourceGroup().location]",
            "name": "[concat(variables('serviceBusNamespaceName'), '/', parameters('IncomingDeliveryRequestsTopicName'), '/Log')]",
            "properties": {
                "deadLetteringOnFilterEvaluationExceptions": false,
                "deadLetteringOnMessageExpiration": true,
                "defaultMessageTimeToLive": "14.00:00:00",
                "enableBatchedOperations": false,
                "lockDuration": "00:00:30",
                "maxDeliveryCount": 10,
                "requiresSession": false
            },
            "resources": [
                {
                    "apiVersion": "2015-08-01",
                    "dependsOn": [
                        "[resourceId('Microsoft.ServiceBus/namespaces/topics/subscriptions', variables('serviceBusNamespaceName'), parameters('IncomingDeliveryRequestsTopicName'), 'Log')]"
                    ],
                    "name": "LogAll",
                    "properties": {
                        "filter": {
                            "sqlExpression": "1=1"
                        }
                    },
                    "type": "Rules"
                }
            ],
            "type": "Microsoft.ServiceBus/namespaces/topics/subscriptions"
        },
        {
            "apiVersion": "2015-08-01",
            "dependsOn": [
                "[resourceId('Microsoft.ServiceBus/namespaces', variables('serviceBusNamespaceName'))]",
                "[resourceId('Microsoft.ServiceBus/namespaces/topics', variables('serviceBusNamespaceName'), parameters('IncomingDeliveryRequestsTopicName'))]"
            ],
            "location": "[resourceGroup().location]",
            "name": "[concat(variables('serviceBusNamespaceName'), '/', parameters('IncomingDeliveryRequestsTopicName'), '/LowPriority')]",
            "properties": {
                "deadLetteringOnFilterEvaluationExceptions": false,
                "deadLetteringOnMessageExpiration": true,
                "defaultMessageTimeToLive": "14.00:00:00",
                "enableBatchedOperations": false,
                "lockDuration": "00:00:30",
                "maxDeliveryCount": 10,
                "requiresSession": false
            },
            "resources": [
                {
                    "apiVersion": "2015-08-01",
                    "dependsOn": [
                        "[resourceId('Microsoft.ServiceBus/namespaces/topics/subscriptions', variables('serviceBusNamespaceName'), parameters('IncomingDeliveryRequestsTopicName'), 'LowPriority')]"
                    ],
                    "name": "LowPriority",
                    "properties": {
                        "filter": {
                            "sqlExpression": "Priority='Low'"
                        }
                    },
                    "type": "Rules"
                }
            ],
            "type": "Microsoft.ServiceBus/namespaces/topics/subscriptions"
        },
        {
            "apiVersion": "2015-08-01",
            "dependsOn": [
                "[resourceId('Microsoft.ServiceBus/namespaces', variables('serviceBusNamespaceName'))]",
                "[resourceId('Microsoft.ServiceBus/namespaces/topics', variables('serviceBusNamespaceName'), parameters('IncomingDeliveryRequestsTopicName'))]"
            ],
            "location": "[resourceGroup().location]",
            "name": "[concat(variables('serviceBusNamespaceName'), '/', parameters('IncomingDeliveryRequestsTopicName'), '/NormalPriority')]",
            "properties": {
                "deadLetteringOnFilterEvaluationExceptions": false,
                "deadLetteringOnMessageExpiration": true,
                "defaultMessageTimeToLive": "14.00:00:00",
                "enableBatchedOperations": false,
                "lockDuration": "00:00:30",
                "maxDeliveryCount": 10,
                "requiresSession": false
            },
            "resources": [
                {
                    "apiVersion": "2015-08-01",
                    "dependsOn": [
                        "[resourceId('Microsoft.ServiceBus/namespaces/topics/subscriptions', variables('serviceBusNamespaceName'), parameters('IncomingDeliveryRequestsTopicName'), 'NormalPriority')]"
                    ],
                    "name": "NormalPriority",
                    "properties": {
                        "filter": {
                            "sqlExpression": "Priority='Normal'"
                        }
                    },
                    "type": "Rules"
                }
            ],
            "type": "Microsoft.ServiceBus/namespaces/topics/subscriptions"
        }
    ]
}